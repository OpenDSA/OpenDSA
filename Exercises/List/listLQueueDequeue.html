<!--
List-based dequeue mini-proficiency exercise.
Written by Junyang Chen and Cliff Shaffer
-->

<!DOCTYPE html>
<html data-require="math">
<head>
  <title>List-based dequeue Proficiency Exercise</title>
  <script src="../../lib/jquery.min.js"></script>
  <script src="../../lib/jquery-ui.min.js"></script>
  <script src="../../JSAV/lib/jquery.transform.light.js"></script>
  <script src="../../JSAV/lib/raphael.js"></script>
  <script src="../../ODSAkhan-exercises/khan-exercise.js"></script>
  <script src="../../JSAV/build/JSAV.js"></script>
  <link rel="stylesheet" href="../../JSAV/css/JSAV.css" type="text/css" />

  <style>
    .jsavcontainer {
      height: 200px;
      border: 0px;
    }
    .jsavcanvas{
      height: 200px;
    }
    .jsavhorizontallist.jsavautoresize .jsavnode {
      min-width: 30px;
      max-width: 30px;
      min-height: 30px;
      max-height: 30px;
      line-height: 30px;
      padding-right: 12px;
    }
    .jsavhorizontalarray.jsavautoresize .jsavnode {
      min-width: 30px;
      max-width: 30px;
      min-height: 30px;
      max-height: 30px;
      line-height: 30px;
    }
    .bgColor{
      font-size: 130%;
      background-color: yellow;
    }
    .jsavlist.jsavautoresize.jsavhorizontallist{
      height: 150px;
    }
    .jsavcanvas svg{
      height: 150px;
      overflow: show;
    }
    .jsavpointer{
      width: 40px;
      border: 1px solid #bbb;
      text-align: center;
	  cursor: pointer;
    }
    .highlight{
      background-color: yellow;
    }
    #reset { margin-right: 20px;}
  </style>
</head>
<body>
<script>
var jsav,               // The JSAV object
  leftMargin,           //
  topMargin,            //
  answerArr = [],       // The (internal) array that stores the correct answer
  answerOrderArr = [],  // The (internal) array that stores the correct order of nodes
  answFrontNode,        //
  answRearNode,         //
  answCopyFrom,         //
  orderArr = [],        // Stores the node.id() of the jsavList
  listArr = [],         // Stores the jsav list values
  front,                // pointer front
  rear,                 // pointer rear
  front_target,         //
  rear_target,          //
  selected_pointer,     // pointer that is clicked, which will always be front here.
  selected_node,
  status = 0,           // Nothing is currently selected, status = 0;
                        // listNode is selected, status = 1;
                        // pointer area is selected, status = 2;
                        // pointer is selected, status = 3.
  newNodeGen,    
  newLinkNode,          // New node
  odsa_head,            // head of the list for correct answer
  connections = [],
  fromNode,
  toNode,
  jsavList,             // JSAV list
  returnArr,
  copyFrom,
  listSize,             // JSAV list size
  insertValue,          // Value to be inserted
  userInput;            // Boolean: Tells us if user ever did anything

// JSAV extension
JSAV._types.ds.ListNode.prototype.pNum = 0;
JSAV._types.ds.ListNode.prototype.odsa_next = null;
JSAV._types.ds.ListNode.prototype.odsa_tail = null;
JSAV._types.ds.ListNode.prototype.odsa_edgeToNext = null;
JSAV._types.Pointer.prototype.click = function(fn){
  var pointer = this;
  this.element.click(function(){fn(pointer)});
}

// pointer click handler
function pclick(pointer){
  selected_pointer = pointer;
  selected_pointer.element.toggleClass('highlight');
  status = 3;
  userInput = true;
}

// Helper function for seting pointer
function setPointer(name, node, opt){

  var pointerRight = {anchor: "right top",
    myAnchor: "left bottom",fixed: "true",
    left: -10,
    top: -20};
  var pointerLeft = {anchor: "left top",
    myAnchor: "right bottom",fixed: "true",
    left: 15,
    top: -20};
  if(node.pNum == 1)
  {
    node.pNum ++;
    return node.jsav.pointer(name, node, pointerRight);
  }else if(node.pNum == 0){
    node.pNum ++;
    return node.jsav.pointer(name, node, pointerLeft); 
  }
}

// Add an edge from obj1 to obj2 
function connection(obj1, obj2){
  if(obj1 == obj2){ return;}
  var left = obj1.jsav.container.find(".jsavcanvas:first").offset().left;
  var top = obj1.jsav.container.find(".jsavcanvas:first").offset().top;
  var fx = obj1.element.offset().left + 39 - left;
  var tx = obj2.element.offset().left  +2 - left;	  
  var fy = obj1.element.offset().top + 16 - top;
  var ty = obj2.element.offset().top + 16 - top;
  var fx1 = fx, fy1 = fy, tx1 = tx, ty1 = ty;

  var disx = (fx - tx - 22) > 0 ? 1 : (fx - tx - 22) == 0 ? 0 : -1;
  var disy = (fy - ty) > 0 ? 1 : (fy - ty) == 0 ? 0 : -1;
  
  var dx = Math.max(Math.abs(fx - tx) / 2, 35);
  var dy = Math.max(Math.abs(fy - ty) / 2, 35);

  if(fy - ty > -25 && fy - ty < 25 && (tx - fx < 36 || tx - fx > 38)){
    dx = Math.min(Math.abs(fx - tx), 20);
    dy = Math.min(Math.abs(fx - tx)/3, 50);
    tx += 22;
    ty -= 15;
    fx1 = fx; 
    fy1 = fy - dy;
    tx1 = tx - dx;
    ty1 = ty - dy;
  }else{
    if(disx == 1){
      tx += 22;
      ty += 15 * disy;
      fx1 = fx + dx; 
      fy1 = fy - dy * disy;
      tx1 = tx;
      ty1 = ty + dy * disy;
    }else if(disx == -1){
      fx1 = fx + dx; 
      fy1 = fy;
      tx1 = tx - dx;
      ty1 = ty;	
    }
  }
  
  var edge = jsav.g.path(["M", fx, fy , "C", fx1, fy1, tx1 , ty1, tx, ty].join(","),{"arrow-end": "classic-wide-long", "opacity": 100,"stroke-width": 2,} );
  if(obj1.odsa_next){
    obj1.odsa_edgeToNext.element.remove();	
  }else{
    obj1.odsa_tail.element.remove();
    obj1.odsa_tail = null;
  }
  obj1.odsa_edgeToNext = edge;
}

// Function for connecting to nodes when click them 
function Connect(obj1, obj2){
  if(obj1 == obj2){ return;}
  connection(obj1,obj2);
  obj1.odsa_next = obj2;
  obj1._next = obj2;
  for(var i=0; i<connections.length; i++)
  {
    if(connections[i].from == obj1 && connections[i].to != obj2){
      connections[i].to = obj2;
      return;
    }
  }
    connections.push({from: obj1, to: obj2});  
}

function copyHandler(){
  if(status == 1){
    copyFrom = selected_node;
    jsav.effects.copyValue(selected_node, returnArr, 0);
    selected_node.unhighlight();
    status = 0;
  }
}

// Click event handler on the list
function clickHandler(e) {
  var setright = {anchor: "right top", myAnchor: "left bottom", left: -10, top:-20};
  var setleft = {anchor: "left top", myAnchor: "right bottom", left: 15, top:-20};
  var x = parseInt(e.pageX - $('#' + this.id()).offset().left);
  var y = parseInt(e.pageY - $('#' + this.id()).offset().top);
  if(x > 31 && x < 42 && y > 0 && y < 31){	
    if(status == 0){
      $('#' + this.id() + " .jsavpointerarea:first").addClass('bgColor');
      fromNode = this;
      status = 2;
    }else if(status == 2){
      $('#' + fromNode.id() + " .jsavpointerarea:first").removeClass('bgColor');
      if(this.id() == fromNode.id()){
        $('#' + this.id() + " .jsavpointerarea:first").removeClass('bgColor');
        fromNode = null;
        status = 0;
      }else{
        $('#' + this.id() + " .jsavpointerarea:first").addClass('bgColor');
        fromNode = this;
        status = 2;
      }
    }else if(status == 1){
      selected_node.unhighlight();
      $('#' + this.id() + " .jsavpointerarea:first").addClass('bgColor');
      fromNode = this;
      status = 2;
    }
  }else{
    if(status == 2){
      toNode = this;
      Connect(fromNode, toNode);
      $('#' + fromNode.id() + " .jsavpointerarea:first").removeClass('bgColor');
      $('#' + toNode.id()).removeClass('bgColor');
      fromNode = null;
      toNode = null;
      status = 0;
    }else if(status == 3){
      if(selected_pointer.target() !== this){
        selected_pointer.target().pNum--;
        if(this.pNum == 1){
          selected_pointer.target(this,setright);
          this.pNum++;
        }else if(this.pNum == 0){
          selected_pointer.target(this,setleft);
          this.pNum++;
        }
      }
      jsav.container.trigger("jsav-updaterelative");
      selected_pointer.element.removeClass("highlight");
      selected_pointer = null;
      status = 0;
    }else if(status == 0){
      this.highlight();
      selected_node = this;
      status = 1;
    }else if(status == 1){
      if(selected_node == this){
        this.unhighlight();
        status = 0;
      }else{
        selected_node.unhighlight();
        selected_node = this;
        this.highlight();
      }
	}
    userInput = true;
  }
};

// Add a tail for the target node
function addTail(node){
  var left = node.element.offset().left - jsav.container.find(".jsavcanvas:first").offset().left;
  var top = node.element.offset().top - jsav.container.find(".jsavcanvas:first").offset().top;
  var fx = left + 34;
  var tx = left + 44;
  var fy = top + 32;
  var ty = top + 1;

  if(node.odsa_tail){;
    node.odsa_tail.element.remove();
    node.odsa_tail = jsav.g.line(fx,fy,tx,ty,{"opacity": 100,"stroke-width": 1});
  }else{
    node.odsa_edgeToNext.element.remove();
    node.odsa_next = null;
    node.odsa_tail = jsav.g.line(fx,fy,tx,ty,{"opacity": 100,"stroke-width": 1});
  }
  node.odsa_next = null;
}

// Click handler function for makenull button
function f_makenull(){
  if(status == 2){
    fromNode.element.removeClass('bgColor');
    addTail(fromNode);
    fromNode = null;
    status = 0;
  }
}

// reset function definition
function f_reset() {
  leftMargin = 20;
  topMargin = 60;
  userInput = false;
  newNodeGen = false;
  connections = [];
  selected_node = null;
  copyFrom = null;
  status = 0;  

  // Clear old JSAV canvas
  if($("#jsav")){
    $("#jsav").empty();
  }

  // Build JSAV Objects
  jsav = new JSAV("jsav");	
  jsavList = jsav.ds.list({"nodegap": 30, "top": topMargin, left: leftMargin});
  returnArr = jsav.ds.array(["null"], {left : leftMargin + 62, top: topMargin + 70});
  for(var i = listSize - 1; i >= 0; i--)
  {
	jsavList.addFirst(listArr[i]);
  }
  jsavList.layout(); 
  front = setPointer("front", jsavList.get(0));
  rear = setPointer("rear", jsavList.get(listSize - 1));
  jsav.recorded();
  jsav.forward();


  for(var i = 0; i < listSize; i ++)
  {
    // Store JSAV List orders
    orderArr[i] = jsavList.get(i).id();
    // Assign .odsa_next the object of the next JSAV node 
    jsavList.get(i).odsa_next = jsavList.get(i).next();
    // Assign odsa_edgeToNext the edge connecting the JSAV node to the following node
    jsavList.get(i).odsa_edgeToNext = jsavList.get(i).edgeToNext();
  }
  // Manually add tail to the last node.
  jsavList.get(listSize - 1).odsa_tail = jsav.g.line(leftMargin + 34 + (listSize - 1)*74, 32 + topMargin,
                          leftMargin + 44 + (listSize - 1)*74, 1 + topMargin,{"opacity": 100,"stroke-width": 1});

  // Correct answer
  answerOrderArr = orderArr.slice(0);
  if(listSize !== 1)
  {
    answerOrderArr.splice(1, 1);
    answerOrderArr.length = listSize - 1;
    answCopyFrom = jsavList.get(1);
  }else{
    answCopyFrom = null;
  }
  answFrontNode = jsavList.get(0);
  if(listSize === 2){
    answRearNode = jsavList.get(0);
  }else{
    answRearNode = jsavList.get(listSize - 1);
  }

  // Bind click event handlers.
  front.click(pclick);
  rear.click(pclick);  
  returnArr.click(copyHandler);
  jsavList.click(clickHandler);

  userInput = false;
};

// Initialise the exercise
function initJSAV(size) {
  listSize = size;
  answerArr.length = 0;

  answerArr[0] = "null";
  // Give random numbers in range 0..999
  for (i = 1; i < size+1; i++) {
    answerArr[i] = Math.floor(Math.random() * 1000);
  }
  // Make a copy.
  listArr = answerArr.slice(0);

  f_reset();

  // correct answer
  if(listSize !== 1)
  {
    answerArr.splice(1, 1);
    answerArr.length = listSize - 1;
  }

  // Set up handler for 'makenull'
  $("#makenull").click(function () { f_makenull(); });
  // Set up handler for reset button
  $("#reset").click(function () { f_reset(); });
};

// Check user's answer for correctness: User's array must match answer
function checkAnswer(arr_size) {
  var i = 0,
    curr = jsavList.get(0);

  if(front.target() !== answFrontNode){ return false;}
  if(rear.target()!== answRearNode) { return false};
  if( answCopyFrom !== copyFrom) {return false;}

  while(curr){
    if(curr.value() == answerArr[i] && curr.id() == answerOrderArr[i]){
      curr = curr.odsa_next;
      i++;
    }else{
      return false;
    }
  }

  if(listSize == 1){
    return true;
  }else if(i == listSize - 1)
  {
    return true;
  }

  return false;
};
</script>

<div class="exercise">
  <div class="vars">
    <var id="arr_size">randRange(1, 6)</var>
    <var id="JSAV">initJSAV(arr_size)</var>
  </div>

  <div class="problems">
    <div> <!-- Supresses answer box -->
      <p class="problem" id = "test"></p>
      <div class="question">
	<p>Dequeue a value from the linked queue. First move the
        correct value to the box shown below the list. Then update any
        necessary pointers. If a pointer variable needs to be set to
        null, then click the pointer and then click on the "Make Null" button.</p>
        <input id="reset" type="button" value="Reset" />
        <input id="makenull" type="button" value="Make Null" />
        <div id="jsav" style = "{background-color : #333}"></div>
      </div>
      <div class="solution" data-type="custom">
        <div class="guess">
          [userInput]
        </div>
        <div class="validator-function">
          if (!checkAnswer(arr_size) && !guess[0])
            return ""; // User did not click, and correct answer is not
	               // initial array state
          else return checkAnswer(arr_size);
        </div>
      </div>
      <div class="hints">
      </div>
    </div>
  </div>
</div>
</body>
</html>
